# 1Password Secrets Integration for GitHub Actions
#
# This reusable workflow loads secrets from 1Password using a service account.
# Other workflows can call this as a reusable workflow or use the pattern directly.
#
# Prerequisites:
#   1. 1Password Service Account created with access to required vault(s)
#   2. Service account token stored as GitHub secret: OP_SERVICE_ACCOUNT_TOKEN
#
# Usage in other workflows:
#   jobs:
#     load-secrets:
#       uses: ./.github/workflows/1password-secrets.yml
#       secrets: inherit
#
# Or use the pattern directly in your workflow (see example job below).

name: 1Password Secrets

on:
  workflow_call:
    outputs:
      # Add outputs for non-sensitive values if needed
      secrets_loaded:
        description: "Whether secrets were successfully loaded"
        value: ${{ jobs.load-secrets.outputs.secrets_loaded }}
  workflow_dispatch:
    # Manual trigger for testing the integration

permissions:
  contents: read

jobs:
  load-secrets:
    name: Load 1Password Secrets
    runs-on: ubuntu-latest
    outputs:
      secrets_loaded: ${{ steps.load.outputs.success }}

    steps:
      - name: Verify service account token exists
        run: |
          if [ -z "${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}" ]; then
            echo "::error::OP_SERVICE_ACCOUNT_TOKEN secret is not set"
            exit 1
          fi
          echo "✅ Service account token is configured"

      - name: Load secrets from 1Password
        id: load
        uses: 1password/load-secrets-action@v2
        with:
          # Export loaded secrets as environment variables
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          # Oxylabs Residential Proxy credentials
          OXYLABS_RESIDENTIAL_USERNAME: op://DEV/OXYLABS_RESIDENTIAL/username
          OXYLABS_RESIDENTIAL_PASSWORD: op://DEV/OXYLABS_RESIDENTIAL/credential  # pragma: allowlist secret
          # Oxylabs Web Scraper API credentials
          OXYLABS_SCRAPER_API_USERNAME: op://DEV/OXYLABS_SCRAPER_API/username
          OXYLABS_SCRAPER_API_PASSWORD: op://DEV/OXYLABS_SCRAPER_API/credential  # pragma: allowlist secret
          # Anthropic API key
          ANTHROPIC_API_KEY: op://DEV/ANTHROPIC_API_KEY/credential  # pragma: allowlist secret
          # Claude Code OAuth token (for claude-code-action)
          CLAUDE_CODE_OAUTH_TOKEN: op://DEV/CLAUDE_CODE_OAUTH_TOKEN/credential  # pragma: allowlist secret
          # Sentry error monitoring
          SENTRY_DSN: op://DEV/SENTRY_DSN/credential  # pragma: allowlist secret

      - name: Verify secrets loaded
        run: |
          echo "success=true" >> $GITHUB_OUTPUT
          echo "✅ 1Password secrets loaded successfully"

  # Example: Using loaded secrets in a dependent job
  example-usage:
    name: Example - Using Secrets
    runs-on: ubuntu-latest
    needs: load-secrets
    if: github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v6

      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          OXYLABS_RESIDENTIAL_USERNAME: op://DEV/OXYLABS_RESIDENTIAL/username
          OXYLABS_RESIDENTIAL_PASSWORD: op://DEV/OXYLABS_RESIDENTIAL/credential  # pragma: allowlist secret
          OXYLABS_SCRAPER_API_USERNAME: op://DEV/OXYLABS_SCRAPER_API/username
          OXYLABS_SCRAPER_API_PASSWORD: op://DEV/OXYLABS_SCRAPER_API/credential  # pragma: allowlist secret
          ANTHROPIC_API_KEY: op://DEV/ANTHROPIC_API_KEY/credential  # pragma: allowlist secret
          CLAUDE_CODE_OAUTH_TOKEN: op://DEV/CLAUDE_CODE_OAUTH_TOKEN/credential  # pragma: allowlist secret
          SENTRY_DSN: op://DEV/SENTRY_DSN/credential  # pragma: allowlist secret

      - name: Verify secrets are available
        run: |
          # This just verifies the secrets are set (doesn't print values)
          # In real workflows, these would be used by your scripts
          echo "Secrets verification complete"
          # Example: python run.py --retailer verizon --proxy residential
